{% extends "questionnaire/base.html" %}

{% block title %}{{ page.title }} â€” {{ questionnaire.name }}{% endblock %}

{% block script %}
<script>
    document.addEventListener('alpine:init', () => {
        const formDataKey = 'formData' + '{{ questionnaire.id }}';
        const storageKey = 'q_{{ questionnaire.id }}_formData';

        Alpine.store(formDataKey, JSON.parse(localStorage.getItem(storageKey) || '{}'));

        Alpine.data('questionnairePage', () => ({
            save(event) {
                const fd = new FormData(event.target);
                const data = {};
                for (const key of fd.keys()) {
                    const vals = fd.getAll(key);
                    data[key] = vals.length === 1 ? vals[0] : vals;
                }
                Object.assign(Alpine.store(formDataKey), data);
                localStorage.setItem(storageKey, JSON.stringify(Alpine.store(formDataKey)));
            }
        }));
    });
</script>
{% endblock %}

{% block body_attrs %}x-data="questionnairePage"{% endblock %}

{% block body %}
<h1 class="text-3xl font-bold mb-4">{{ questionnaire.name }}</h1>
<h2 class="text-xl font-semibold mb-6 text-gray-700">{{ page.title }}</h2>
<form method="post" @submit="save" class="space-y-6">

    {% csrf_token %}

    {% if errors %}
    <div class="mb-6 rounded-lg border border-red-200 bg-red-50 p-4">
        <p class="text-sm font-semibold text-red-700 mb-1">The following fields have problems:</p>
        <ul class="list-disc list-inside text-sm text-red-600">
            {% for field in errors %}
            <li>{{ field }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {{ rendered_content|safe }}
    <div class="pt-4">
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors font-semibold">
            Next
        </button>
    </div>
</form>
{% endblock %}
